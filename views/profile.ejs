<% include ./partials/header.ejs %>

<div class="profile w-full min-h-screen bg-stone-50 pt-1">
    <!-- Profile details -->
    <form id="uploadform" hidden action="/fileupload" method="post" enctype="multipart/form-data">
        <input type="file" name="image">
    </form>
    <div class="profdets flex flex-col items-center mt-10">
        <div class="w-32 h-32 bg-zinc-200 rounded-full overflow-hidden">
            <img id="uploadicon" class="w-full h-full object-cover" src="/images/uploads/<%= user.profileImage %>" alt="">
        </div>
        <h1 class="text-3xl font-semibold mt-2"><%= user.name %></h1>
        <h3 class="text-md">@<%= user.username %></h3>
        <div class="flex mt-5">
            <a href="/edit" class="px-10 py-3 bg-zinc-300 mx-1 text-sm font-semibold rounded-full">Edit</a>
            <!-- Trigger for Add Board Modal -->
            <button id="addBoardBtn" class="px-10 py-3 bg-zinc-300 mx-1 rounded-full text-sm font-semibold">Add New Board</button>
        </div>
    </div>

<!-- profile.ejs -->
<div class="cards flex flex-wrap gap-10 px-10 mt-10">
    <% user.board.forEach(board => { %>
      <div class="card w-52 relative group">
        
        <!-- Delete icon button with red background and white icon, visible only on hover -->
        <button class="delete-icon absolute top-2 right-2 hidden group-hover:flex items-center justify-center w-8 h-8 bg-red-500 text-white rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>

        <!-- Board image and link to posts in board -->
        <a href="/show/posts?boardId=<%= board._id %>" class="w-52 h-32 bg-zinc-200 overflow-hidden">
          <% if (board.posts.length > 0) { %>
            <img class="w-full h-auto object-cover rounded-md" src="/images/uploads/<%= board.posts[0].image %>" alt="First post image">
          <% } else { %>
            <img class="w-full h-auto object-cover rounded-md" src="/images/default-placeholder.png" alt="Placeholder">
          <% } %>
        </a>

        <!-- Board title and post count -->
        <h4 class="text-xl font-semibold mt-3"><%= board.title %></h4>
        <h5 class="text-sm font-medium opacity-60"><%= board.posts.length %> Pins</h5>
        
        <!-- "Create Post" button -->
        <a href="/add?boardId=<%= board._id %>" class="text-red-500 font-semibold mt-2 inline-block">+ Create Post</a>
      </div>
    <% }) %>
</div>
      
</div>

<!-- Add Board Modal -->
<div id="addBoardModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white rounded-lg p-6 w-80">
        <h2 class="text-xl font-bold mb-4">Add New Board</h2>
        <form id="addBoardForm" action="/board" method="POST">
            <label class="block mb-2 text-sm font-medium text-gray-700">Board Title</label>
            <input type="text" name="title" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:border-blue-500" required>
            <button type="submit" class="mt-4 w-full bg-red-500 hover:bg-red-700 text-white py-2 rounded-md">Create Board</button>
        </form>
        <button id="closeModalBtn" class="mt-4 text-sm text-gray-500 hover:text-gray-700">Cancel</button>
    </div>
</div>

<script>
    // Trigger file upload when clicking profile image
    document.querySelector("#uploadicon").addEventListener("click", function() {
        document.querySelector("#uploadform input").click();
    });

    document.querySelector("#uploadform input").addEventListener("change", function() {
        document.querySelector("#uploadform").submit();
    });

    // Show Add Board Modal
    document.getElementById("addBoardBtn").addEventListener("click", function() {
        document.getElementById("addBoardModal").classList.remove("hidden");
    });

    // Hide Add Board Modal
    document.getElementById("closeModalBtn").addEventListener("click", function() {
        document.getElementById("addBoardModal").classList.add("hidden");
    });

    document.querySelectorAll(".delete-icon").forEach(button => {
        button.addEventListener("click", async function(event) {
            event.preventDefault();
            const boardId = this.getAttribute("data-board-id");

            const confirmed = confirm("Are you sure you want to delete this board and all its posts?");
            if (confirmed) {
                try {
                    const response = await fetch(`/board/${boardId}`, { method: "DELETE" });
                    if (response.ok) {
                        // Remove the board from the DOM
                        this.closest(".card").remove();
                    } else {
                        alert("Failed to delete the board.");
                    }
                } catch (error) {
                    console.error("Error deleting board:", error);
                    alert("An error occurred. Please try again.");
                }
            }
        });
    });

</script>

<% include ./partials/footer.ejs %>
